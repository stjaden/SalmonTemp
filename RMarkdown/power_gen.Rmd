---
title: "Dworshack_2018data"
author: "Savannah Tjaden"
date: "5/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)


```


```{r}

#load elevation data
dworshack_elv <- read_csv("../Data/dworshack_elv.csv") 

#load flow data
dworshack_flow <- read_csv("../Data/dworshack_flow.csv")


```



Calculate the head available for power generation

head = forebay elevation (ft) - tailwater elevation (ft)

```{r}

# create new column that calculates head and remove NAs
dworshack_head <- dworshack_elv %>% 
  mutate(head = (forebay_elv - tailwater_elv)) %>% 
  select(date, head) %>% 
  na.omit() 


# convert head from ft to m
dworshack_head <- mutate(dworshack_head, head_m = dworshack_head$head*0.3048)




```


Calculate flow for power generation. This could be an input parameter, but then there would be no change in power generation when outflows values are changed. 

power generation flow = total outflow (kcfs) - spill (kcfs) 

This ignore losses, which are generally pretty low

```{r}

#create column with claculated flow for power gen
power_flow <- dworshack_flow %>% 
  mutate(calc_power_flow = (total_outflow - spill_flow)) 

#convert kcfs to L/s 
power_flow_Ls <- power_flow %>% 
  select(date, total_outflow, spill_flow, calc_power_flow) %>% 
  mutate(total_outflow_Ls = (total_outflow * 28.32)) %>% 
  mutate(spill_flow_Ls = spill_flow * 28.32) %>% 
  mutate(calc_power_flow_Ls = calc_power_flow * 28.32)



```


Merge final inputs into single df

```{r}

flow_inputs <- power_flow_Ls %>% 
  select(date, total_outflow_Ls, spill_flow_Ls, calc_power_flow_Ls) 


head_inputs <- dworshack_head %>% 
  select(date, head_m)
  
historic_inputs <- merge(flow_inputs, head_inputs)

historic_inputs$date <- as.Date(historic_inputs$date, "%m/%d/%Y")


```


Try running power gen model

```{r}

source("../R/dshack_powergen.R")


test_data <- historic_inputs %>% 
  select(date, calc_power_flow_Ls, head_m) %>% 
  mutate(date = ymd(date)) %>% 
  mutate_at(vars(date), funs(year, month, day)) %>% 
  filter(year == 2018)


reservoir_model_res= as.data.frame(matrix(nrow=365, ncol=4))
colnames(reservoir_model_res)=c("date", "head","flowrate","power")

reservoir_model_res$date = test_data$date
reservoir_model_res$head = test_data$head_m
reservoir_model_res$flowrate = test_data$calc_power_flow_Ls

reservoir_model_res$power = mapply(FUN=max_power, head =reservoir_model_res$head, flow=reservoir_model_res$flowrate)

reservoir_model_res <- mutate(reservoir_model_res, power_MW = (power/100000)*2.5)



#plot results

ggplot(reservoir_model_res, aes(x=date, y=power_MW))+
  geom_line()


```

Check if modeled values are cloe to actual power generation values in 2018

```{r}

powergen_2018 <- read_csv("../Data/powergen_2018.csv")
colnames(powergen_2018) = c("date", "measured_power")
powergen_2018$date <- as.Date(powergen_2018$date, "%m/%d/%Y")



ggplot()+
  geom_line(data = reservoir_model_res, aes(x=date, y=power_MW)) +
  geom_line(data = powergen_2018, aes(x= date, y=measured_power, color = "red"))
  




```


